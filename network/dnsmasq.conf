# ==============================================================================
# dnsmasq Configuration - DHCP & DNS for Captive Portal
# ==============================================================================
# This file configures DHCP server and DNS for captive portal redirection
# 
# Location: /etc/dnsmasq.conf
# ==============================================================================

# General Settings
# ----------------
# Don't read /etc/resolv.conf
no-resolv

# Don't poll /etc/resolv.conf for changes
no-poll

# Interface to listen on (only the WiFi AP interface)
interface=wlan0

# Don't listen on these interfaces
except-interface=eth0
except-interface=lo

# Bind only to interfaces we're listening on
bind-interfaces

# DHCP Configuration
# ------------------
# DHCP range: start IP, end IP, subnet mask, lease time
dhcp-range=192.168.4.2,192.168.4.254,255.255.255.0,24h

# Gateway (the Raspberry Pi itself)
dhcp-option=option:router,192.168.4.1

# DNS server (point to ourselves for captive portal DNS hijacking)
dhcp-option=option:dns-server,192.168.4.1

# Domain name
dhcp-option=option:domain-name,captive.local

# NTP server (optional, use Pi as NTP or external)
#dhcp-option=option:ntp-server,192.168.4.1

# DHCP lease file location
dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases

# Authoritative DHCP server (speeds up lease acquisition)
dhcp-authoritative

# DNS Configuration
# -----------------
# Upstream DNS servers (used for authenticated clients)
server=8.8.8.8
server=8.8.4.4
server=1.1.1.1

# Local domain
domain=captive.local
local=/captive.local/

# Captive Portal DNS Hijacking
# ----------------------------
# Redirect all DNS queries to the captive portal IP
# This ensures all HTTP requests go to our portal
address=/#/192.168.4.1

# IMPORTANT: Comment the line above and uncomment below after authentication
# to allow normal DNS resolution. This is handled by the firewall rules.

# Allow specific domains even when hijacking (for portal resources)
# Uncomment if needed:
#server=/captive.local/192.168.4.1

# Captive Portal Detection Domains
# --------------------------------
# These domains are queried by devices to detect captive portals
# We redirect them to trigger the portal detection

# Android
address=/connectivitycheck.gstatic.com/192.168.4.1
address=/connectivitycheck.android.com/192.168.4.1
address=/clients3.google.com/192.168.4.1

# Apple iOS/macOS
address=/captive.apple.com/192.168.4.1
address=/www.apple.com/192.168.4.1
address=/www.appleiphonecell.com/192.168.4.1

# Microsoft Windows
address=/www.msftncsi.com/192.168.4.1
address=/www.msftconnecttest.com/192.168.4.1
address=/ipv6.msftconnecttest.com/192.168.4.1

# Firefox
address=/detectportal.firefox.com/192.168.4.1

# Logging
# -------
# Log DNS queries (useful for debugging)
log-queries

# Log DHCP transactions
log-dhcp

# Log facility
log-facility=/var/log/dnsmasq.log

# Performance & Security
# ----------------------
# Cache DNS entries
cache-size=1000

# Don't forward queries without domain part
domain-needed

# Don't forward reverse lookups for private ranges
bogus-priv

# Don't read /etc/hosts
no-hosts

# Add local machine to hosts (for captive.local resolution)
addn-hosts=/etc/dnsmasq.hosts

# Rate limiting (prevent DNS amplification attacks)
# Max queries per second per client
#dns-forward-max=150

# ==============================================================================
# MAC-based DHCP Reservations (Optional)
# ==============================================================================
# Reserve specific IPs for known devices
# Format: dhcp-host=<MAC>,<IP>,<hostname>,<lease-time>
#
# Example:
# dhcp-host=AA:BB:CC:DD:EE:FF,192.168.4.100,admin-laptop,infinite
# ==============================================================================

# ==============================================================================
# DHCP Script Hook (for dynamic MAC tracking)
# ==============================================================================
# Run script on DHCP events (add, old, del)
# This allows the captive portal to track DHCP leases
dhcp-script=/opt/captive-portal/network/scripts/dhcp-hook.sh
# ==============================================================================
